rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ”’ Public exercises collection - Read-only for everyone
    match /exercises/{exerciseId} {
      allow read: if true;
      allow write: if false; // ğŸ” Secure: disallow public writes
    }

    // ğŸ”’ Exercise metadata collection - Read-only for everyone
    match /exercise_metadata/{docId} {
      allow read: if true;
      allow write: if false; // ğŸ” Secure: disallow public writes
    }

    // ğŸ” Main workouts collection (for planned workouts)
    match /workouts/{workoutId} {
      allow read, write: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ” User tokens for authentication persistence (root collection)
    match /userTokens/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ğŸ‹ï¸â€â™€ï¸ User fitness profiles for journey tracking (root collection)
    match /userFitnessProfiles/{userId} {
      allow read, write: if isOwner(userId);
      
      // Workout sessions subcollection for detailed session tracking
      match /workoutSessions/{sessionId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ğŸ” All user data is scoped to /profiles/{userId}
    match /profiles/{userId} {
      allow read, write: if isOwner(userId);

      match /workouts/{workoutId} {
        allow read, write: if isOwner(userId);
      }

      match /goals/{goalId} {
        allow read, write: if isOwner(userId);
      }

      match /feedback/{feedbackId} {
        allow read, write: if isOwner(userId);
      }

      match /history/{historyId} {
        allow read, write: if isOwner(userId);
      }

      match /favoriteExercises/{favoriteId} {
        allow read, write: if isOwner(userId);
      }

      match /favoriteWorkouts/{favoriteWorkoutId} {
        allow read, write: if isOwner(userId);
      }

      match /workoutDrafts/{draftId} {
        allow read, write: if isOwner(userId);
      }

      match /maxLifts/{maxLiftId} {
        allow read, write: if isOwner(userId);
      }

      match /weightHistory/{weightEntryId} {
        allow read, write: if isOwner(userId);
      }

      match /myExercises/{exerciseId} {
        allow read, write: if isOwner(userId);
      }

      match /tokens/{tokenId} {
        allow read, write: if isOwner(userId);
      }

      // ğŸ HealthKit settings for each user
      match /healthKitSettings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // ğŸ¤– AI Chat messages for each user
      match /chatMessages/{messageId} {
        allow read, write: if isOwner(userId);
      }

      // ğŸ“± Social sharing settings for each user
      match /socialSharing/preferences {
        allow read, write: if isOwner(userId);
      }

      // ğŸ“Š Social sharing activity log
      match /socialSharingActivity/{activityId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ğŸ“Š Feature usage tracking (root collection for performance)
    match /featureUsage/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ğŸ” Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
  }
}